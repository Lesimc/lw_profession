<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Single Column Talent Tree</title>

  <style>
    :root{
      --bg:#0f1115;
      --panel:#151a22;
      --line:#2a3242;
      --text:#e8eefc;
      --muted:#aab4cf;
      --red:#d34b4b;
      --yellow:#d0a432;
      --green:#3bb273;
      --tile:#1d2431;
      --tile2:#202a3b;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family:system-ui,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,var(--bg),#0b0d12);
      color:var(--text);
    }

    header{
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      background:rgba(10,12,18,.75);
      position:sticky;
      top:0;
      z-index:2;
      backdrop-filter: blur(6px);
    }

    .top{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    h1{margin:0;font-size:18px}

    .sub{
      color:var(--muted);
      font-size:12px;
      margin-top:4px;
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      background:var(--panel);
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }

    .pill strong{color:var(--text)}

    /* editable budget input */
    #budgetInput{
      width:72px;
      background:transparent;
      color:var(--text);
      border:1px solid rgba(42,50,66,.9);
      border-radius:10px;
      padding:4px 8px;
      font-weight:900;
      font-size:12px;
      outline:none;
    }
    #budgetInput:focus{
      border-color:#3a4760;
    }

    button{
      background:var(--tile2);
      color:var(--text);
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
    }

    /* optional build input */
    #buildBox{
      width:min(520px, 92vw);
      background:transparent;
      color:var(--text);
      border:1px solid rgba(42,50,66,.9);
      border-radius:10px;
      padding:8px 10px;
      font-weight:700;
      font-size:12px;
      outline:none;
    }
    #buildBox:focus{ border-color:#3a4760; }

    main{
      padding:18px;
      max-width:980px;
      margin:0 auto;
    }

    .legend{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
      margin-bottom:12px;
    }

    .dot{
      display:inline-block;
      width:10px;
      height:10px;
      border-radius:50%;
    }

    .dot.red{background:var(--red)}
    .dot.yellow{background:var(--yellow)}
    .dot.green{background:var(--green)}

    .tree{
      background:rgba(21,26,34,.65);
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
    }

    .treeHeader{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:linear-gradient(180deg, rgba(30,40,60,.55), rgba(21,26,34,.2));
    }

    .treeHeader .name{font-weight:900}
    .treeHeader .hint{color:var(--muted);font-size:12px}

    .row{
      display:grid;
      grid-template-columns:58px 1fr 1fr 1fr;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(42,50,66,.55);
      align-items:center;
    }

    .row:last-child{border-bottom:none}

    .tier{
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      background:rgba(15,20,32,.6);
      border:1px solid rgba(42,50,66,.7);
      border-radius:12px;
      padding:8px 0;
      font-weight:800;
      font-size:12px;
    }

    .talent{
      position:relative;
      background:linear-gradient(180deg,var(--tile),rgba(15,20,32,.75));
      border:1px solid rgba(42,50,66,.8);
      border-radius:14px;
      padding:10px 12px;
      min-height:62px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      cursor:pointer;
    }

    .talent:hover{border-color:#3a4760}

    .icon{
      width:34px;
      height:34px;
      border-radius:10px;
      background:linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      font-weight:900;
      margin-top:1px;
    }

    .meta{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
      flex:1;
    }

    .tname{
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .desc{ display:none; }

    .badge{
      align-self:flex-start;
      min-width:36px;
      height:22px;
      padding:0 6px;
      border-radius:999px;

      display:inline-flex;
      align-items:center;
      justify-content:center;

      font-weight:900;
      font-size:11px;

      border:2px solid rgba(0,0,0,.35);
      box-shadow:0 4px 10px rgba(0,0,0,.35);
    }

    .state-red{background:var(--red)}
    .state-yellow{background:var(--yellow)}
    .state-green{background:var(--green)}

    /* Tooltip */
    .tooltip{
      position:fixed;
      z-index:9999;
      max-width:min(520px, calc(100vw - 24px));
      padding:10px 12px;
      border-radius:12px;
      background:rgba(10,12,18,.96);
      border:1px solid rgba(42,50,66,.9);
      box-shadow:0 10px 30px rgba(0,0,0,.55);
      pointer-events:none;
      opacity:0;
      transform:translateY(6px);
      transition:opacity .08s ease, transform .08s ease;
    }

    .tooltip.show{
      opacity:1;
      transform:translateY(0);
    }

    .tooltip .tt-title{
      font-weight:900;
      font-size:13px;
      margin-bottom:6px;
    }

    .tooltip .tt-desc{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
<header>
  <div class="top">
    <div>
      <h1>Season 4 Engineer Profession Tree</h1>
      <div class="sub">Click = +1 â€¢ Right-click = âˆ’1 â€¢ Shift+Click = max</div>
    </div>

    <div class="controls">
      <div class="pill">
        Points: <strong id="spent">0</strong> /
        <input id="budgetInput" type="number" min="0" step="1" value="115" />
      </div>

      <button id="copyLinkBtn" type="button">Copy Share Link</button>
      <button id="resetBtn" type="button">Reset</button>
    </div>
  </div>

  <!-- Optional: share code import/export -->
  <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
    <input id="buildBox" type="text" placeholder="Paste build code here (or click Copy Share Link)" />
    <button id="loadBtn" type="button">Load</button>
    <button id="copyCodeBtn" type="button">Copy Code</button>
  </div>
</header>

<main>
  <div class="legend">
    <span><span class="dot green"></span> Maxed</span>
    <span><span class="dot yellow"></span> Points used</span>
    <span><span class="dot red"></span> No points</span>
  </div>

  <div class="tree">
    <div class="treeHeader">
      <div class="name">S4 Engineer Tree</div>
      <div class="hint" id="hint"></div>
    </div>
    <div id="rows"></div>
  </div>
</main>

<div id="tooltip" class="tooltip">
  <div class="tt-title" id="ttTitle"></div>
  <div class="tt-desc" id="ttDesc"></div>
</div>

<script>
/* Budget is editable */
let POINT_BUDGET = 115;

const TIERS = [100,95,90,85,80,75,70,65,60,55,50,45,40,35,30,25,20,15,10,5,1];

/* Your full TALENTS list continuesâ€¦ (kept as you provided) */
const TALENTS = [
  // Lv. 1
  { id:"rp", tier:1, slot:0, icon:"ðŸ›¡ï¸", name:"Rapid Production", desc:"Use it to immediately gain 4 hours per Level of production from in-base Food, Iron and Coin buildings, cooldown 24 hours.", max:5 },
  { id:"oc", tier:1, slot:1, icon:"âš”ï¸", name:"Outstanding Contribution", desc:"Donating Tech helps increase Alliance Contribution earned.", max:1 },
  { id:"ce", tier:1, slot:2, icon:"ðŸ’‰", name:"Combat Experience", desc:"Increased Profession EXP by 20% per level from killing monsters.", max:3 },
  //Lv.5
  { id:"a5", tier:5, slot:0, icon:"ðŸ›¡ï¸", name:"Extra Meal", desc:"The effect of Daily Freebie for stamina has been improved.", max:1 },
  { id:"d5", tier:5, slot:1, icon:"âš”ï¸", name:"Siege Mastery", desc:"Unit durability damage increases by 100 (based on level)", max:5 },
  { id:"r5", tier:5, slot:2, icon:"ðŸ’‰", name:"Building Inspiration", desc:"Increased Profession EXP from upgrading Season building.", max:3 },
  //Lv.10
  { id:"a10", tier:10, slot:0, icon:"ðŸ›¡ï¸", name:"Build for Free", desc:"Increase free speed-up time for Constructions by 48 min per Level.", max:1 },
  { id:"d10", tier:10, slot:1, icon:"âš”ï¸", name:"Research for Free", desc:"Increase free speed-up time for Research by 48 min per Level.", max:5 },
  { id:"r10", tier:10, slot:2, icon:"ðŸ’‰", name:"Double Exchange", desc:"Exchange two types of seasonal resources at 1:2 ration, consuming 5.000 (up to 25.000) and gaining 10.000 (up to 50.000), with a cooldown of 47.5 hours.", max:3 },
  //Lv.15
  { id:"a15", tier:15, slot:0, icon:"ðŸ›¡ï¸", name:"Build Now", desc:"Use it to immediately reduce all Construction Queue time by 120 minutes (based on level), cooldown 47.5 hours.", max:5 },
  { id:"d15", tier:15, slot:1, icon:"âš”ï¸", name:"Research Now", desc:"Use it to immediately reduce all Research Queue time by 240 minutes (based on level), cooldown 47.5 hours", max:5 },
  { id:"r15", tier:15, slot:2, icon:"ðŸ’‰", name:"Contaminated Land Teleport", desc:"Gain a free Contaminated Land Teleport every 47.5 hours without consuming items, up to 1 stored at a time.", max:1 },
  //Lv.20
  { id:"a20", tier:20, slot:0, icon:"ðŸ›¡ï¸", name:"Rally Rush", desc:"Joining or returning with rallies boosts troop marching speed by 10/20/30/40/50%.", max:5 },
  { id:"d20", tier:20, slot:1, icon:"âš”ï¸", name:"Siege Banner", desc:"Use it to set up â€œSiege Bannerâ€. Increases the damage of allies whose bases are within the bannerâ€™s range by 100, lasting 30 minute, cooldown 72 hours (stack up to 5 times)", max:1 },
  { id:"r20", tier:20, slot:2, icon:"ðŸ’‰", name:"Professional Insights", desc:"Use to instantly gain 2% (up to 10%) of your current levelâ€™s Profession EXP, up to a maximum of 100,000, with a cooldown of 23.5 hours.", max:5 },
  //Lv.25
  { id:"a25", tier:25, slot:0, icon:"ðŸ›¡ï¸", name:"Siege Inspiration", desc:"Increased Profession EXP from damaging City Durability by 20% (based on level).", max:3 },
  { id:"d25", tier:25, slot:1, icon:"âš”ï¸", name:"Friendly Aid", desc:"When reinforcing an allyâ€™s base, the casualty rate of the Drill Groundâ€™s units decreases (not stackable) by 5% (based on level).", max:5 },
  { id:"r25", tier:25, slot:2, icon:"ðŸ’‰", name:"Trade Discount", desc:"Enjoy 10% extra discounts when purchasing items from Trade Posts.", max:1 },
  //Lv.30
  { id:"a30", tier:30, slot:0, icon:"ðŸ›¡ï¸", name:"Cooperative Construction", desc:"Boost building speed by 10% (based on level) for both you and a selected ally for 60 minutes, with a 23.5 hours cooldown (multiple instances do not stack).", max:2 },
  { id:"d30", tier:30, slot:1, icon:"âš”ï¸", name:"Cooperative Research", desc:"Boost research speed by 10% (based on level) for both you and a selected ally for 60 minutes, with a 23.5 hours cooldown (multiple instances do not stack)", max:2 },
  { id:"r30", tier:30, slot:2, icon:"ðŸ’‰", name:"Top Up EXP", desc:"After the electrician powers up the units in the world and returns home, they will earn additional Profession EXP equal to the charging power * 1. The daily limit is 100k profession exp points.", max:1 },
  //Lv.35
  { id:"a35", tier:35, slot:0, icon:"ðŸ›¡ï¸", name:"Resource-Saving", desc:"Reduce the cost of Food, Iron, and Coin for construction by 1/2/3/4/5%.", max:5 },
  { id:"d35", tier:35, slot:1, icon:"âš”ï¸", name:"Recycling", desc:"Reduce the cost of Food, Iron, and Coin for research by 1/2/3/4/5%.", max:5 },
  { id:"r35", tier:35, slot:2, icon:"ðŸ’‰", name:"Fragile Spell", desc:"When Desert Protectors defeat an enemy base, they reduce the target baseâ€™s max durability by 1,000 (up to 5000)", max:1 },
  //Lv.40
  { id:"a40", tier:40, slot:0, icon:"ðŸ›¡ï¸", name:"Medial Aid", desc:"Choose an Ally to use. After use, both yours and their Hospitalâ€™s Capacity increase by 10/20/30/40/50%, lasting for 240 minutes, cooldown 72 hours (multiple instances do not stack)", max:5 },
  { id:"d40", tier:40, slot:1, icon:"âš”ï¸", name:"Buddy Shield", desc:"Activate a shield for 1/2/4 hours for yourself or an ally, with a 71.5-hour cooldown (effects do not stack)", max:3 },
  { id:"r40", tier:40, slot:2, icon:"ðŸ’‰", name:"Shrinking Spell", desc:"When Desert Protectors defeat an enemy base, they reduce the visual size of the target base by 15% stacking up to 5 times.", max:1 },
  //Lv.45
  { id:"a45", tier:45, slot:0, icon:"ðŸ›¡ï¸", name:"Drone Supply", desc:"Use this item to get a level 1/2/3/4/5 Engineer skill reward. Cooldown 23.5h", max:5 },
  { id:"d45", tier:45, slot:1, icon:"âš”ï¸", name:"Suicide Squad", desc:"When defending the base, a proportion of the attacking units will be killed based on the level and number of your fallen units +1% (up to 5%)", max:5 },
  { id:"r45", tier:45, slot:2, icon:"ðŸ’‰", name:"Blood Night Hunter", desc:"After Blood Night Descends, you can use it to become a Blood Night Hunter (week 2 with the appropriate event), gaining exclusive Buffs, until eliminated or the event ends, with a cooldown of 71.5 hour(s) (unaffected by the One More Time Skill). During Warâ€™s Eve event the cooldown will be reduced to 47.5h.", max:1 },
  //Lv.50
  { id:"a50", tier:50, slot:0, icon:"ðŸ›¡ï¸", name:"Random Visitors", desc:"Get 1 random survivor. 119.5 hours (down to 23.5 hours) cooldown", max:5 },
  { id:"d50", tier:50, slot:1, icon:"âš”ï¸", name:"Durability Mine", desc:"Deploy a [Durability Landmine] in the original Warzone. When triggered, it lowers the targetâ€™s durability by 500 points, At max level, it can ignite the enemy base. The mine lasts 24-hour, cooldown 72 hours. You can store up to 2.", max:5 },
  { id:"r50", tier:50, slot:2, icon:"ðŸ’‰", name:"Blood Night Hunter Teleport", desc:"After becoming a Blood Night Hunter, you gain one [Hunter Teleport] count every 60 second(s) (unaffected by the One More Time skill). Hunter Teleport: During the period as a Blood Night Hunter, â€˜Advanced Teleporterâ€™ items cannot be used, only this skill can be used for advanced teleport.", max:1 },
  //Lv.55
  { id:"a55", tier:55, slot:0, icon:"ðŸ›¡ï¸", name:"One More", desc:"The daily task points chest has a 5% (up to 25%) chance to double your rewards.", max:5 },
  { id:"d55", tier:55, slot:1, icon:"âš”ï¸", name:"Support Boost", desc:"Time helped per action +30 seconds ( up to 150 seconds)", max:5 },
  { id:"r55", tier:55, slot:2, icon:"ðŸ’‰", name:"Hunting Inspiration", desc:"After becoming a Blood Night Hunter, earn 30000 Profession EXP for each Blood Night Hunter you eliminate, up to a maximum of 5 per round (unaffected by the One More Time skill).", max:1 },
  //Lv.60
  { id:"a60", tier:60, slot:0, icon:"ðŸ›¡ï¸", name:"Efficient Gathering", desc:"Gathering speed +5 % (up to 25 % )", max:5 },
  { id:"d60", tier:60, slot:1, icon:"âš”ï¸", name:"First Aid Expert", desc:"When defeated, the proportion entering the Emergency Center +1/2/3/4/5%", max:5 },
  { id:"r60", tier:60, slot:2, icon:"ðŸ’‰", name:"Electrician Rally Call", desc:"Use to send an Electrician Rally Message to your alliance. Allies can quickly assist with electricians. Lasts for 10 minute(s). Cooldown: 23.5 hour(s).", max:1 },
  //Lv.65
  { id:"a65", tier:65, slot:0, icon:"ðŸ›¡ï¸", name:"Battlefield Cleanup", desc:"After defeating Ironhead, Glutton, Miser, and Doom Elites, the gain for Coin, Food, and Iron +2/4/6/8/10%", max:5 },
  { id:"d65", tier:65, slot:1, icon:"âš”ï¸", name:"Master Builder", desc:"Building speedup +5 % (up to +25 %)", max:5 },
  { id:"r65", tier:65, slot:2, icon:"ðŸ’‰", name:"Flare", desc:"Use to illuminate a 9-tile radius with L1 Light (can reveal Mini Maneki-neko) for 5 minute(s). Effects do not stack. Cooldown: 47.5 hour(s). Note: This is similar to the bomb we had in Season 2.", max:1 },
  //Lv.70
  { id:"a70", tier:70, slot:0, icon:"ðŸ›¡ï¸", name:"Instant Gathering", desc:"When used, all squads currently gathering at iron mines, farmland, or gold mines will immediately collect the remaining resources from the gathering tile and return (cannot exceed the squadâ€™s load capacity). Cooldown: 119.5 hours (down to 23.5 hours). Only usable in your home warzone.", max:5 },
  { id:"d70", tier:70, slot:1, icon:"âš”ï¸", name:"Monster Tracking", desc:"Marching speed against monsters +5 % (up to 25 %)", max:5 },
  { id:"r70", tier:70, slot:2, icon:"ðŸ’‰", name:"Lightfall", desc:"Once the enemy base is breached, their lighthouse will be extinguished and cannot be relight for the next 3 minute(s). Additionally, 3-5 allied electricians dispatched to that base will be randomly sent back.", max:1 },
  //Lv.75
  { id:"a75", tier:75, slot:0, icon:"ðŸ›¡ï¸", name:"Win-Win Cooperation", desc:"Can only be used on the War Leader Reduces their construction and tech research costs by 5% for 24 hours. Earn 1 rewards. Cooldown: 23.5 hours.", max:1 },
  { id:"d75", tier:75, slot:1, icon:"âš”ï¸", name:"Free Teleport", desc:"Gain one free Advanced Teleport chance every 71.5 hours, up to 1 (up to 3) stored at a time.", max:3 },
  { id:"r75", tier:75, slot:2, icon:"ðŸ’‰", name:"Disruption Mine", desc:"You can deploy a [Disruption Mine] in empty tiles of the original warzone: If triggered by an enemy, they canâ€™t turn on the light for 3 minutes. The mine remains active for 24 hour and has a cooldown of 23.5 hours. Disruption Mine: Commanders from the same warzone and faction are immune. Triggered when other commanders relocate and make contact.", max:1 },
  //Lv.80
  { id:"a80", tier:80, slot:0, icon:"ðŸ›¡ï¸", name:"Truck Expansion", desc:"Increases the amount of Iron, Food, and Coins carried by the Truck by +5 % (up to 25%).", max:5 },
  { id:"d80", tier:80, slot:1, icon:"âš”ï¸", name:"Helping Hand", desc:"Increases the number of helps received by +1 (up to +5)", max:5 },
  { id:"r80", tier:80, slot:2, icon:"ðŸ’‰", name:"Oni Summon", desc:"Duration: 5 minutes. While active, the Blood Night Oni Legion can be attracted to follow your troops. Should they lose their target, theyâ€™ll turn on the brightest nearby base. Defeat the Blood Night Oni Legion to earn rewards. Cooldown 47.5 hour(s) (unaffected by the One More Time skill). IMPORTANT: you can learn it only starting from day 15 of the season", max:1 },
  //Lv.85
  { id:"a85", tier:85, slot:0, icon:"ðŸ›¡ï¸", name:"Speedup Box", desc:"It grands 1 (up to 5) random speedup item(s). Cooldown: 23.5 hours", max:5 },
  { id:"d85", tier:85, slot:1, icon:"âš”ï¸", name:"Emergency Capacity", desc:"Increase the capacity limit by 50/100/150/200/250 of the Emergency Center.", max:5 },
  { id:"r85", tier:85, slot:2, icon:"ðŸ’‰", name:"Summon Mummies", desc:"Target an unshielded enemy commander to summon a mummy boss near your base. The boss will march to attack the target for 30 minutes, cooldown 71.5 hours. Enemy commander = Commanders from the same warzone and faction are immune. IMPORTANT: you need Protectorâ€™s Field at level 25 to learn (acquire) this skill.", max:1 },
  //Lv.90
  { id:"a90", tier:90, slot:0, icon:"ðŸ›¡ï¸", name:"Willing Helper", desc:"When helping allies, you earn an extra 50 Alliance Contribution Points (does not affect contribution rankings). Daily limit: 4 times (up to 20).", max:5 },
  { id:"d90", tier:90, slot:1, icon:"âš”ï¸", name:"Enhance Siege Banner", desc:"Upgrade the Siege Banner to gain an additional +10% rally and march speed {unlocks at Siege Banner max level), lasts 30 minutes, cooldown 71.5 hours (stacks up to 5 times).", max:1 },
  { id:"r90", tier:90, slot:2, icon:"ðŸ’‰", name:"Regen", desc:"+1 HP/s", max:5 },
  //Lv.95
  { id:"a95", tier:95, slot:0, icon:"ðŸ›¡ï¸", name:"Cooperative Construction II", desc:"Cooperative Construction Upgrade: Each level adds +5% construction speed boost (unlocks at Cooperative Construction max level), lasts 60 minutes, cooldown: 23,5 hours", max:5 },
  { id:"d95", tier:95, slot:1, icon:"âš”ï¸", name:"Cooperative Research II", desc:"Cooperative Research Upgrade: Each level adds +5% research speed boost (unlocks at Cooperative Research max level), lasts 60 minutes, cooldown: 23,5 hours", max:5 },
  //Lv.100
  { id:"a100", tier:100, slot:0, icon:"ðŸ›¡ï¸", name:"One More Time", desc:"When using an active skill (with a hexagon-shaped icon), there is a 4% (up to 20%) chance to skip cooldown. Each skill can trigger this effect only once per day.", max:5 },
  { id:"d100", tier:100, slot:1, icon:"âš”ï¸", name:"Blast", desc:"Use it on your base to activate War Fever mode, triggering a 60-second Blast countdown. The blast will damage nearby 3 base tiles, reducing their durability by 25%, Cooldown: 71.5 hours.", max:1 }
];

const state = { points:Object.fromEntries(TALENTS.map(t=>[t.id,0])) };

const rowsEl = document.getElementById("rows");
const spentEl = document.getElementById("spent");
document.getElementById("hint").textContent = `${TIERS.length} tiers â€¢ 3 skills per tier`;

const tooltip = document.getElementById("tooltip");
const ttTitle = document.getElementById("ttTitle");
const ttDesc  = document.getElementById("ttDesc");

/* Budget input wiring */
const budgetInput = document.getElementById("budgetInput");
POINT_BUDGET = Math.max(0, Math.floor(Number(budgetInput.value) || 0));
budgetInput.addEventListener("input", () => {
  POINT_BUDGET = Math.max(0, Math.floor(Number(budgetInput.value) || 0));
  render();
});

/* ===== Build Share (encode/decode) ===== */
function b64urlEncode(str){
  return btoa(unescape(encodeURIComponent(str)))
    .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
}
function b64urlDecode(str){
  const pad = str.length % 4 ? "=".repeat(4 - (str.length % 4)) : "";
  const b64 = (str + pad).replace(/-/g, "+").replace(/_/g, "/");
  return decodeURIComponent(escape(atob(b64)));
}

function serializeBuild(){
  const pts = Object.entries(state.points).filter(([,v]) => (v|0) > 0);
  return { v: 1, b: POINT_BUDGET, p: pts };
}

function applyBuild(payload){
  if (!payload || payload.v !== 1 || !Array.isArray(payload.p)) return false;

  if (typeof payload.b === "number" && Number.isFinite(payload.b)) {
    POINT_BUDGET = Math.max(0, Math.floor(payload.b));
    budgetInput.value = String(POINT_BUDGET);
  }

  for (const k of Object.keys(state.points)) state.points[k] = 0;

  for (const pair of payload.p){
    if (!Array.isArray(pair) || pair.length < 2) continue;
    const id = pair[0];
    const val = pair[1];
    if (!(id in state.points)) continue;
    const t = TALENTS.find(x => x.id === id);
    const max = t ? t.max : 999;
    state.points[id] = Math.max(0, Math.min(max, Math.floor(Number(val) || 0)));
  }
  return true;
}

function buildCode(){
  return b64urlEncode(JSON.stringify(serializeBuild()));
}

function loadCode(code){
  try{
    const payload = JSON.parse(b64urlDecode(code.trim()));
    return applyBuild(payload);
  }catch{
    return false;
  }
}

function shareLink(){
  const url = new URL(window.location.href);
  url.searchParams.set("build", buildCode());
  return url.toString();
}

/* Share UI */
const copyLinkBtn = document.getElementById("copyLinkBtn");
const copyCodeBtn = document.getElementById("copyCodeBtn");
const buildBox = document.getElementById("buildBox");
const loadBtn = document.getElementById("loadBtn");

copyLinkBtn.addEventListener("click", async () => {
  const link = shareLink();
  const code = new URL(link).searchParams.get("build") || "";
  if (buildBox) buildBox.value = code;
  try { await navigator.clipboard.writeText(link); } catch {}
});

copyCodeBtn.addEventListener("click", async () => {
  const code = buildCode();
  if (buildBox) buildBox.value = code;
  try { await navigator.clipboard.writeText(code); } catch {}
});

loadBtn.addEventListener("click", () => {
  const code = (buildBox?.value || "").trim();
  if (!code) return;
  if (loadCode(code)) render();
});

/* Auto-load from URL */
(function autoLoadFromUrl(){
  const url = new URL(window.location.href);
  const code = url.searchParams.get("build");
  if (!code) return;
  if (loadCode(code)) {
    if (buildBox) buildBox.value = code;
    render();
  }
})();

render();

function getSpent(){
  return Object.values(state.points).reduce((a,b)=>a+b,0);
}

function render(){
  rowsEl.innerHTML="";
  for(const tier of TIERS){
    const row=document.createElement("div");
    row.className="row";

    const tierBox=document.createElement("div");
    tierBox.className="tier";
    tierBox.textContent=tier;
    row.appendChild(tierBox);

    const bySlot=new Map(TALENTS.filter(t=>t.tier===tier).map(t=>[t.slot,t]));
    for(let i=0;i<3;i++){
      const t=bySlot.get(i);
      if(!t){
        const e=document.createElement("div");
        e.className="talent";
        e.style.opacity=0;
        e.style.pointerEvents="none";
        row.appendChild(e);
      }else row.appendChild(renderTalent(t));
    }
    rowsEl.appendChild(row);
  }
  spentEl.textContent = String(getSpent());
}

function renderTalent(t){
  const v=state.points[t.id];
  const stateClass=v===0?"state-red":(v>=t.max?"state-green":"state-yellow");

  const el=document.createElement("div");
  el.className="talent";
  el.innerHTML=`
    <div class="icon">${t.icon}</div>
    <div class="meta">
      <div class="tname">${t.name}</div>
      <div class="badge ${stateClass}">${v}/${t.max}</div>
      <div class="desc"></div>
    </div>
  `;

  el.onmouseenter=()=>showTooltip(`${t.name} (${state.points[t.id]}/${t.max})`,`Tier ${t.tier}\n\n${t.desc}`);
  el.onmousemove=e=>moveTooltip(e.clientX,e.clientY);
  el.onmouseleave=hideTooltip;

  el.onclick=e=>{
    const cur = state.points[t.id];
    const add = e.shiftKey ? (t.max - cur) : 1;
    if(getSpent() + add <= POINT_BUDGET){
      state.points[t.id]=Math.min(t.max,cur+add);
      render();
    }
  };

  el.oncontextmenu=e=>{
    e.preventDefault();
    const cur = state.points[t.id];
    state.points[t.id]=Math.max(0,cur-1);
    render();
  };

  return el;
}

function showTooltip(title,desc){
  ttTitle.textContent=title;
  ttDesc.textContent=desc;
  tooltip.classList.add("show");
}
function hideTooltip(){ tooltip.classList.remove("show"); }
function moveTooltip(x,y){
  const pad=14;
  tooltip.style.left=Math.min(x+pad,window.innerWidth-tooltip.offsetWidth-8)+"px";
  tooltip.style.top=Math.min(y+pad,window.innerHeight-tooltip.offsetHeight-8)+"px";
}

document.getElementById("resetBtn").onclick=()=>{
  Object.keys(state.points).forEach(k=>state.points[k]=0);
  render();
  hideTooltip();
};
</script>
</body>
</html>
